name: Deploy Docs to GitHub Pages

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install dependencies (root)
        run: yarn install

      - name: Clear all builds
        run: yarn clean

      - name: Build all packages
        run: yarn build

      - name: Install Docusaurus dependencies
        working-directory: ./docs
        run: yarn install

      - name: Set environment variables
        working-directory: ./docs
        run: |
          echo "API_BASE_URL=${{ secrets.API_BASE_URL }}" >> .env
          echo "DOCSEARCH_APP_ID=${{ secrets.DOCSEARCH_APP_ID }}" >> .env
          echo "DOCSEARCH_API_KEY=${{ secrets.DOCSEARCH_API_KEY }}" >> .env
          echo "DOCSEARCH_INDEX_NAME=${{ secrets.DOCSEARCH_INDEX_NAME }}" >> .env

      - name: Build Docusaurus
        working-directory: ./docs
        run: yarn build

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install pipenv
        run: pip install pipenv

      - name: Populate the docs (DocSearch)
        continue-on-error: true
        working-directory: ./docs
        env:
          APPLICATION_ID: ${{ secrets.DOCSEARCH_APP_ID }}
          API_KEY: ${{ secrets.DOCSEARCH_API_KEY }}
        run: |
          if [ -z "$APPLICATION_ID" ] || [ -z "$API_KEY" ]; then
            echo "DocSearch credentials not configured, skipping DocSearch population"
            exit 0
          fi
          if [ -f "./docsearch.config.json" ]; then
            # Clone docsearch-scraper repository
            SCRAPER_DIR=$(mktemp -d)
            git clone --depth 1 https://github.com/algolia/docsearch-scraper.git "$SCRAPER_DIR"
            cd "$SCRAPER_DIR"
            
            # Install dependencies
            pipenv install
            
            # Run the scraper with the config file (using absolute path)
            CONFIG_PATH="${{ github.workspace }}/docs/docsearch.config.json"
            pipenv run ./docsearch run "$CONFIG_PATH"
          else
            echo "Warning: docsearch.config.json not found, skipping DocSearch population"
          fi

      - name: Deploy ðŸš€
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs/build/
          cname: ui.kousta.org
